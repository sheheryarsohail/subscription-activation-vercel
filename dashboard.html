<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Activation Codes Dashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f6f6f7; margin:0; }
    header { padding:16px; background:#111; color:#fff; }
    h1 { margin:0; font-size:20px; }
    .container { padding:20px; max-width:1100px; margin:auto; }
    .filters { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:16px; }
    .filters label { font-size:13px; color:#444; }
    .filters input, .filters select { padding:4px 6px; font-size:13px; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th,td { padding:8px 10px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }
    th { background:#fafafa; }
    tr:hover { background:#f2f2f2; cursor:pointer; }
    .totals { margin:20px 0; font-size:14px; }
    .pagination { margin-top:16px; display:flex; gap:8px; align-items:center; }
    .pagination button { padding:6px 10px; cursor:pointer; }
    .drawer { position:fixed; top:0; right:0; width:380px; height:100%; background:#fff; 
              box-shadow:-3px 0 10px rgba(0,0,0,.2); transform:translateX(100%);
              transition:transform .3s ease; padding:20px; overflow-y:auto; }
    .drawer.open { transform:translateX(0); }
    .drawer h2 { margin-top:0; }
    .muted { color:#666; font-size:13px; }
    .qr { max-width:100%; margin:12px 0; }
    .close { background:none; border:none; font-size:18px; float:right; cursor:pointer; }
  </style>
</head>
<body>
  <header><h1>Activation Codes Dashboard</h1></header>
  <div class="container">

    <!-- Filters -->
    <div class="filters">
      <label>Search<br><input type="text" id="q" placeholder="Code / Sub / Email"></label>
      <label>Status<br>
        <select id="status">
          <option value="">All</option>
          <option value="unused">Unused</option>
          <option value="used">Used</option>
        </select>
      </label>
      <label>Issued From<br><input type="date" id="issuedFrom"></label>
      <label>Issued To<br><input type="date" id="issuedTo"></label>
      <label>Used From<br><input type="date" id="usedFrom"></label>
      <label>Used To<br><input type="date" id="usedTo"></label>
      <div style="align-self:flex-end">
        <button onclick="applyFilters()">Apply</button>
        <button onclick="resetFilters()">Reset</button>
      </div>
    </div>

    <div class="totals" id="totals"></div>
    <table id="codes">
      <thead>
        <tr>
          <th>Code</th>
          <th>Subscription</th>
          <th>Status</th>
          <th>Issued</th>
          <th>Used</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pagination">
      <button id="prevBtn" onclick="prevPage()" disabled>Prev</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextBtn" onclick="nextPage()" disabled>Next</button>
    </div>
  </div>

  <div class="drawer" id="drawer">
    <button class="close" onclick="closeDrawer()">×</button>
    <div id="drawerContent">Loading…</div>
  </div>

<script>
let currentFilters={}, page=1, limit=20, total=0;

function getFilters(){
  return {
    q: document.getElementById('q').value.trim(),
    status: document.getElementById('status').value,
    issuedFrom: document.getElementById('issuedFrom').value,
    issuedTo: document.getElementById('issuedTo').value,
    usedFrom: document.getElementById('usedFrom').value,
    usedTo: document.getElementById('usedTo').value
  };
}

function applyFilters(){
  currentFilters=getFilters();
  page=1;
  loadCodes();
}

function resetFilters(){
  ['q','status','issuedFrom','issuedTo','usedFrom','usedTo'].forEach(id=>document.getElementById(id).value="");
  currentFilters={}; page=1;
  loadCodes();
}

async function loadCodes(){
  const params=new URLSearchParams();
  for(const [k,v] of Object.entries(currentFilters)){ if(v) params.set(k,v); }
  params.set('limit', limit);
  params.set('offset', (page-1)*limit);

  const resp = await fetch('/api/activations?'+params.toString());
  const data = await resp.json();
  if(!data.ok){ document.querySelector('#totals').textContent = 'Error loading'; return; }

  total=data.totals.total;
  document.querySelector('#totals').textContent =
    `Total: ${data.totals.total} | Used: ${data.totals.used} | Unused: ${data.totals.unused}`;

  const tbody = document.querySelector('#codes tbody');
  tbody.innerHTML='';
  for(const r of data.items){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc(r.code)}</td>
      <td>${esc(r.subscriptionId)}</td>
      <td>${esc(r.status)}</td>
      <td>${r.issuedAt? new Date(r.issuedAt).toLocaleString():''}</td>
      <td>${r.usedAt? new Date(r.usedAt).toLocaleString():''}</td>
      <td>${esc(r.customerEmail)}</td>`;
    tr.onclick=()=>openDetail(r.code);
    tbody.appendChild(tr);
  }

  // update pagination controls
  document.getElementById('pageInfo').textContent = `Page ${page}`;
  document.getElementById('prevBtn').disabled = (page<=1);
  document.getElementById('nextBtn').disabled = (page*limit >= total);
}

function nextPage(){ page++; loadCodes(); }
function prevPage(){ if(page>1){ page--; loadCodes(); } }

async function openDetail(code){
  const drawer=document.getElementById('drawer');
  const content=document.getElementById('drawerContent');
  drawer.classList.add('open');
  content.innerHTML='Loading…';

  const resp=await fetch('/api/activations/'+encodeURIComponent(code));
  const data=await resp.json();
  if(!data.ok){ content.textContent='Error: '+data.error; return; }
  const r=data.item;

  const qrImg = r.qrUrl
    ? `<img class="qr" src="${escapeAttr(r.qrUrl)}" alt="QR" />`
    : '<div class="muted">No QR saved</div>';

  const actLink = r.activateUrl
    ? `<a target="_blank" href="${escapeAttr(r.activateUrl)}">${esc(r.activateUrl)}</a>`
    : '<span class="muted">No link</span>';

  content.innerHTML=`
    <h2>Code ${esc(r.code)}</h2>
    <p><b>Status:</b> ${esc(r.status)}</p>
    <p><b>Subscription:</b> ${esc(r.subscriptionId)}</p>
    <p><b>Email:</b> ${esc(r.customerEmail)}</p>
    <p><b>Issued:</b> ${r.issuedAt? new Date(r.issuedAt).toLocaleString():''}</p>
    <p><b>Used:</b> ${r.usedAt? new Date(r.usedAt).toLocaleString():''}</p>
    <p><b>Activation Link:</b> ${actLink}</p>
    ${qrImg}
  `;
}

function closeDrawer(){ document.getElementById('drawer').classList.remove('open'); }
function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function escapeAttr(s){return esc(s).replace(/"/g,'&quot;');}

loadCodes();
</script>
</body>
</html>
